const pkg = require('./package.json');
const platform = {"darwin": "macos", "win32": "windows", "win64": "windows", "linux": "linux" }[process.platform] || process.platform;
const arch = process.arch || (process.env.hasOwnProperty('PROCESSOR_ARCHITEW6432') ? "x64" : "x32");
const which = require('which');
const path = require('path');
let javaFound = false;

let getPackageName = () => {
    let name = `${pkg.name}-${platform}`;
    if (!javaFound) {
        if (platform === "windows") {
            name += `-${arch === "x64" ? "64" : "32"}`;
        }
        name += `-jre`;
    } else {
        if (platform === "linux") {
            name += `-${arch === "x64" ? "64" : "32" }`;
        }
    }
    return name;
}

let validate = () => {
    if (!javaFound && platform === "linux") {
        console.error('A JRE is required to download and run Sencha Cmd in linux.');
        process.exit(126);
    }
}

let proceedWithInstall = () => {
    validate();
    let pkgName = getPackageName();
    console.log('\x1b[32m\x1b[1m[INF]\x1b[0m', 'Installing Sencha Cmd...');
    require('child_process').exec([
        `npm${/^win/.test(require('os').platform()) ? ".exe" : ""}`,
        'install',
        `${pkgName}@${pkg.version}`
    ].join(' '), (error, stdout, stderr) => {
        try {
            if (!error) {
                require(`${pkgName}/install.js`)(__dirname);
            }
        } catch (err) {
            error = err;
        } finally {
            let loglevel = ["silent", "error", "warn", "http", "info", "verbose", "silly"].indexOf(process.env.npm_config_loglevel);
            if (error) {
                if (loglevel > 3) {
                    console.log(`> [platform-installer][err]: ${error.message ? error.message : error}`);
                }
                if (loglevel > 4) {
                    console.log(`> [platform-installer][err]: ${stderr}`);
                }
            }
            if (loglevel > 3) {
                console.log(`> [platform-installer]: ${stdout}`);
            }
        }
    });
}

try {
    which('java', (err, path) => {
        javaFound = !err && path;
        proceedWithInstall();
    });
} catch (ex) {
    console.error(ex);
    proceedWithInstall();
}

